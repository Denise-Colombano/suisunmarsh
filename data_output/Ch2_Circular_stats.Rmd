---
title: "Ch2_Circular_stats"
author: "Denise Colombano"
date: "July 11, 2017"
output: html_document
---

```{r}
library(tidyverse)
library(ggplot2)
library(magrittr)
library(readr)
library(circular)
library(lubridate)
library(ggthemes)
library(viridis)
```


#### STEP 1. TIDE DATA
```{r, import Tidal dataset from USGS John Donovan created in June 2017}

# import raw dataset
tide <- read_csv("~/GitHub/suisunmarsh/Ch2/Tidal_phases/phasedata.csv")
View(tide)
glimpse(tide)

## Notes:
# make sure date-time is POSIXct list (use Noam Ross tutorial found in https://gist.github.com/noamross/8928124)
# filter to relevant PIT tag time period: May 30, 2013 - March 30, 2015
```

## STEP 1A. Categorize tide values in an EXAMPLE (double check it first on subset)
```{r, Assign categories to normalized values}
## Plot 1: All Data
# plot normalized data (arbitrary values) to determine ranges of slack values around 0,1
scatter <- ggplot(tide, aes(`datetime`, `Value`))
scatter + geom_point()

## Plot 2: Slack tides
# plot normalized data for a short tidal time-series with different colors for example slack tide categories

# create new df with subset data and slack tides
tm1 <- tide %>% 
  filter(datetime<"2013-06-02 07:30:00") %>% 
  mutate(slack=ifelse(`Normalized Value`>0.96, "high", ifelse(`Normalized Value`<0.04, "low", "")))

View(tm1)

# scatter plot
slack.ex <- ggplot(tm1, aes(`datetime`, `Value`, color=`slack`))
slack.ex + geom_point() +
  labs(x="Date/Time", y="Stage", title="Example Slack Tide Categories (High>0.96 and Low<0.04)")+
  theme_gdocs() + scale_color_gdocs()+ theme(plot.title = element_text(hjust = 0.5)) 


## Plot 3: Basic slack, flood, ebb tide categories
# plot normalized data for ... for example slack, flood, ebb categories

# create new df with subset data, new column including neg/pos values for the limb (1= increasing, -1=decreasing)
tm2 <- tide %>% 
  filter(datetime<"2013-06-02 07:30:00") %>% 
  mutate(limb_cat=ifelse(Limb==1, "ascending", "descending")) %>% 
  mutate(normlimb=ifelse(Limb==-1, 0-`Normalized Value`, `Normalized Value`))

slacktd.ex <- tm2 %>%
  mutate(tide=ifelse(`Normalized Value`>=0.96, "High", ifelse(`Normalized Value`<=0.04, "Low", NA))) %>% 
  filter(!is.na(tide))

fld.ex <- tm2 %>% 
  filter(limb_cat=="ascending", between(`Normalized Value`,0.04,0.96)) %>% 
  mutate(tide="Flood")

ebb.ex <- tm2 %>% 
  filter(limb_cat=="descending", between(`Normalized Value`,0.04,0.96)) %>% 
  mutate(tide="Ebb")

tm3 <- rbind(slacktd.ex, fld.ex, ebb.ex)

# scatter plot
basictides.ex <- ggplot(tm3, aes(`datetime`, `Value`, color=`tide`))
basictides.ex + geom_point() +
  labs(x="Date/Time", y="Stage", title="Example Basic Tide Categories")+
  theme_gdocs() + scale_color_gdocs() + theme(plot.title = element_text(hjust = 0.5)) 


## Plot 4: 8 different tide categories
# filter each category separately 
slacktd.ex <- tm2 %>%
  mutate(tide=ifelse(`Normalized Value`>=0.96, "High", ifelse(`Normalized Value`<=0.04, "Low", NA))) %>% 
  filter(!is.na(tide))

incfld.ex <- tm2 %>% 
  filter(between(normlimb,0.04,0.35)) %>% 
  mutate(tide="Increasing Flood")

peakfld.ex <- tm2 %>%
  filter(between(normlimb,0.35,0.66)) %>% 
  mutate(tide="Peak Flood")

decfld.ex <- tm2 %>%
  filter(between(normlimb,0.66,0.96)) %>% 
  mutate(tide="Decreasing Flood")      

decebb.ex <- tm2 %>% 
  filter(between(normlimb,-0.35,-0.04)) %>% 
  mutate(tide="Decreasing Ebb")

peakebb.ex <- tm2 %>% 
  filter(between(normlimb,-0.66,-0.35)) %>% 
  mutate(tide="Peak Ebb")

incebb.ex <- tm2 %>% 
  filter(between(normlimb,-0.96,-0.66)) %>% 
  mutate(tide="Increasing Ebb")

# and then daisy chain them back together into one df
tm4 <- rbind(slacktd.ex, incfld.ex, peakfld.ex, decfld.ex, decebb.ex, peakebb.ex, incebb.ex) # double check number of rows

# scatter plot
alltides.ex <- ggplot(tm4, aes(`datetime`, `Value`, color=`tide`))
alltides.ex + geom_point() +
  labs(x="Date/Time", y="Stage", title="Example All Tide Categories")+
  theme_gdocs() + scale_color_gdocs() + theme(plot.title = element_text(hjust = 0.5)) 
```


## STEP 1B. Categorize tide values for whole study period
```{r}
### Basic tides (4 categories)
# create new df with subset data, new column including neg/pos values for the limb (1= increasing, -1=decreasing)
tide_cat <- tide %>% 
  mutate(limb_cat=ifelse(Limb==1, "ascending", "descending")) %>% 
  mutate(normlimb=ifelse(Limb==-1, 0-`Normalized Value`, `Normalized Value`))

slacktd <- tide_cat %>%
  mutate(tide=ifelse(`Normalized Value`>0.96, "High", ifelse(`Normalized Value`<0.04, "Low", NA))) %>% 
  filter(!is.na(tide))

fld <- tide_cat %>% 
  filter(limb_cat=="ascending", between(`Normalized Value`,0.04,0.96)) %>% 
  mutate(tide="Flood")

ebb <- tide_cat %>% 
  filter(limb_cat=="descending", between(`Normalized Value`,0.04,0.96)) %>% 
  mutate(tide="Ebb")

tide_cat_bind <- rbind(slacktd, fld, ebb)

# scatter plot
basictides <- ggplot(tide_cat_bind, aes(datetime, `Value`, color=`tide`))
basictides + geom_point() +
  labs(x="Date/Time", y="Stage", title="Basic Tide Categories")+
  theme_gdocs() + scale_color_gdocs() + theme(plot.title = element_text(hjust = 0.5))


### All tides (8 categories)
slacktd2 <- tide_cat %>%
  mutate(tide=ifelse(`Normalized Value`>0.96, "High", ifelse(`Normalized Value`<0.04, "Low", NA))) %>% 
  filter(!is.na(tide))

incfld <- tide_cat %>% 
  filter(between(normlimb,0.04,0.35)) %>% 
  mutate(tide="Increasing Flood")

peakfld <- tide_cat %>%
  filter(between(normlimb,0.350000001,0.66)) %>% 
  mutate(tide="Peak Flood")

decfld <- tide_cat %>%
  filter(between(normlimb,0.660000001,0.96)) %>% 
  mutate(tide="Decreasing Flood")      

decebb <- tide_cat %>% 
  filter(between(normlimb,-0.35,-0.04)) %>% 
  mutate(tide="Decreasing Ebb")

peakebb <- tide_cat %>% 
  filter(between(normlimb,-0.66,-0.350000001)) %>% 
  mutate(tide="Peak Ebb")

incebb <- tide_cat %>% 
  filter(between(normlimb,-0.96,-0.660000001)) %>% 
  mutate(tide="Increasing Ebb")

# and then daisy chain them back together into one df
tide_cat_bind2 <- rbind(slacktd2, incfld, peakfld, decfld, decebb, peakebb, incebb) %>% # double check number of rows
  rename(tide8=tide)

# double check num of rows, df to see if there are accidental duplicate assignments
chk <- tide_cat_bind2 %>% 
  group_by(`Date Time`) %>% 
  filter(n()>1)

# create one df with both tide category columns (4,8)
tide_cat_bind3 <- tide_cat_bind2 %>% 
  select(datetime, tide8) # select only 2 rows

tide_cat_all <- tide_cat_bind %>% 
  inner_join(tide_cat_bind3, by="datetime") # join together
View(tide_cat_all)

# scatter plot
alltides <- ggplot(tide_cat_all, aes(`datetime`, `Value`, color=`tide8`))
alltides + geom_point() +
  labs(x="Date/Time", y="Stage", title="All Tide Categories")+
  theme_gdocs() + scale_color_gdocs() + theme(plot.title = element_text(hjust = 0.5))
```




#### STEP 2. PIT TAG SPP-COUNT DATA JOIN
```{r}
# import PIT/ WQ summary data
# from "RushProjectDB: PrepForR" file, with a customized DATETIME15MIN in Excel to match the other format in tide data (important!)
pit <- read_csv("~/GitHub/suisunmarsh/Ch2/Data/DetectionSummaries2.csv")
View(pit)
glimpse(pit)

# check timezone
Sys.timezone(location = TRUE)

# convert date-times to POSIXct to match tide data
pit$`datetime` <- as.POSIXct(pit$DATETIME15MIN, format= "%m/%d/%Y %H:%M:%S", tz="UTC")

# join and double check that the date/times match up correctly
pit_tide_joined <- tide_cat_all %>% 
  left_join(pit, by="datetime")

p <- pit_tide_joined %>% 
  write_csv("~/GitHub/suisunmarsh/Ch2/Data_output/Ch2_Data_PIT_Counts_&_Tides.csv")

View(p)
```


#### STEP 3. SUBSETTING DATA FOR ORIANA
```{r}
# Basic tide categories
timeonly_sum <- p %>% 
  filter(!is.na(DATETIME15MIN)) %>% 
  select(times, tide, ST_Det, SB_Det, TP_Det) %>% 
  group_by(times, tide) %>% 
  summarise(st_freq = sum(ST_Det), sb_freq=sum(SB_Det), tp_freq=sum(TP_Det)) %>% 
  select(times, st_freq, sb_freq, tp_freq, tide ) %>% 
  write_csv("~/GitHub/suisunmarsh/Ch2/Data_output/Ch2_Data_ST_Det_Freq_Times.csv")

# All tide categories
timeonly_sum8 <- p %>% 
  filter(!is.na(DATETIME15MIN)) %>% 
  select(times, tide8, ST_Det, SB_Det, TP_Det) %>% 
  group_by(times, tide8) %>% 
  summarise(st_freq = sum(ST_Det), sb_freq=sum(SB_Det), tp_freq=sum(TP_Det)) %>% 
  select(times, st_freq, sb_freq, tp_freq, tide8 ) %>% 
  write_csv("~/GitHub/suisunmarsh/Ch2/Data_output/Ch2_Data_ST_Det_Freq_Times_Tide8.csv")

```

#### STEP 4. SPRING-NEAP PLOTS 
```{r}
# import 
p <- read_csv("~/GitHub/suisunmarsh/Ch2/Data_output/Ch2_Data_PIT_Counts_&_Tides.csv")

# Spring Magnitude
springmag <- p %>% 
  filter(!is.na(DATETIME15MIN)) %>% 
  select(`Spring Magnitude`, tide, ST_Det, SB_Det, TP_Det) %>% 
  group_by(`Spring Magnitude`, tide) %>% 
  mutate(st_freq = ST_Det, sb_freq=SB_Det, tp_freq=TP_Det) %>% 
  select(`Spring Magnitude`,tide,st_freq, sb_freq, tp_freq) %>% 
  rename(spring=`Spring Magnitude`)

st_spring1 <- springmag %>% 
  select(spring, tide, st_freq) %>% 
  mutate(st_det=ifelse(st_freq>0, "Present","Absent"))

st_filter <- st_spring1 %>% 
  filter(st_det=="Present")

sb_filter <- sb_spring1 %>% 
  filter(sb_det=="Present")

tp_filter <- tp_spring1 %>% 
  filter(tp_det=="Present")

sb_spring1 <- springmag %>% 
  select(spring, tide, sb_freq) %>% 
  mutate(sb_det=ifelse(sb_freq>0, "Present","Absent"))

tp_spring1 <- springmag %>% 
  select(spring, tide, tp_freq) %>% 
  mutate(tp_det=ifelse(tp_freq>0, "Present","Absent"))

# density plots
spring_p <- ggplot(springmag, aes(x=spring, ..count.., fill=tide)) + 
  geom_histogram(position="identity")+
  scale_x_continuous()+
  theme_gdocs()+
  scale_fill_gdocs()
spring_p 

?geom_density

st_spring_p <- ggplot(st_filter, aes(x=spring, ..count.., fill=tide))+
  geom_histogram(position="stack", alpha=0.7)+
  scale_x_continuous()+
  theme_gdocs()+
  scale_fill_gdocs()
st_spring_p 

sb_spring_p <- ggplot(sb_filter, aes(x=spring, ..count.., fill=tide))+
  geom_histogram(position="identity")+
  scale_x_continuous()+
  theme_gdocs()+
  scale_fill_gdocs()
sb_spring_p 


tp_spring_p <- ggplot(tp_filter, aes(x=spring, ..count.., fill=tide))+
  geom_histogram(position="identity")+
  scale_x_continuous()+
  theme_gdocs()+
  scale_fill_gdocs()
tp_spring_p 


sb_spring_p <- ggplot(sb_spring, aes(x=`Spring Magnitude`, fill=tide)) + 
  geom_density(alpha=0.3, stat="density", position="identity", size=0.5) 
sb_spring_p

tp_spring_p <- ggplot(tp_spring, aes(x=`Spring Magnitude`, fill=tide)) + 
  geom_density(alpha=0.3, stat="density", position="identity", size=0.5) 
tp_spring_p





