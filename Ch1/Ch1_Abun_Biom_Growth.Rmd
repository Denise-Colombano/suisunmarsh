---
title: "Ch1_Abun_Biom_Growth"
author: "Denise Colombano"
date: "February 8, 2017"
output: html_document
---

```{r}
library(tidyverse)
library(ggplot2)
library(magrittr)
library(ggthemes)
library(viridis)

chapter1 <- read_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_Abun_Biom_Growth.txt")
View(chapter1)
glimpse(chapter1)
chapter1$id <- 1:5223
str(chapter1)
summary(chapter1)

```

```{r, create data frames}
# create dataset with variables of interest

#Use `select` & `filter`:

 #- can select columns by names, attributes
 #- filter by rows, can filter by values

# Make a dataset using pipes (ctrl + shift + M) in magrittr

chapter1 %>% 
  select(Slough, YearMo, YrSlough, Mo, Yr, `ST_Age-0`, `SB_Age-0`, `TP_Age-0`, TowMin) %>% 
  filter(Mo > 4) %>% 
  group_by(YrSlough, Slough, Yr) %>% 
  summarize(st0_cpue = sum(`ST_Age-0`/ TowMin), sb0_cpue = sum(`SB_Age-0`/ TowMin), tp0_cpue = sum(`TP_Age-0`/ TowMin)) %>% 
  write.csv("~/GitHub/suisunmarsh/Ch1/abundance.csv", row.names=FALSE)

abundance <- read_csv("~/GitHub/suisunmarsh/Ch1/abundance.csv")
glimpse(abundance)
View(abundance)
```

```{r, mean abundance}
# Group by and Summarize

mean_abundance <- abundance %>%
  group_by(Yr) %>% 
  summarize(st0_mean = mean(st0_cpue), sb0_mean = mean(sb0_cpue), tp0_mean = mean(tp0_cpue))
View(mean_abundance)
```

```{r, join back with chapter1 dataframe}

# Following this lesson:

## **https://ismayc.github.io/moderndiver-book/5-manip.html#joining-data-frames**

abundance_joined <- abundance %>%
  inner_join(mean_abundance, by="Yr")
```

```{r, create new columns for pos/neg differences}
abundance_differences <- abundance_joined %>% 
  mutate(Splittail = st0_cpue - st0_mean, Striped_Bass = sb0_cpue - sb0_mean, Tule_Perch = tp0_cpue - tp0_mean) %>% #calculate differences
  select(YrSlough, Slough, Yr, Splittail, Striped_Bass, Tule_Perch) %>% 
  glimpse

a <- abundance_differences # shorthand
View(a)
```

```{r, convert dataframe to from wide to long format}

# Following the R Cookbook:

## *http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/**

# Convert to factors first
a$Slough <- as.factor(a$Slough)
a$Yr <- as.factor(a$Yr)
a$YrSlough <- as.factor(a$YrSlough)

# tidyr gather
a_gathered <- a %>% 
  gather(Species, Relative_CPUE, Splittail:Tule_Perch)
View(a_gathered)
```

## Plotting relative differences
# First let's look at disproportionately greater than average cPUE among Slough & Yr for each species
# Using the a_gathered dataframe, representing differences from the mean (0) for that year

```{r, mean difference bar charts}
a_gathered$Above_Annual_Mean <- a_gathered$Relative_CPUE >= 0
bar <- ggplot(a_gathered, aes(x=Yr, y=Relative_CPUE, fill=Above_Annual_Mean, guide=FALSE)) +
  geom_bar(stat="identity", position="identity") +
  scale_colour_economist() +
  theme_economist_white() +
  guides(fill=guide_legend(reverse=TRUE)) +
  labs(y="Relative Average Catch Per Minute", x="", title="Young-of-Year Catch by Year & Slough")
bar + facet_grid(Species ~ Slough) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5), legend.title = element_text(face="italic", size=12), axis.title.x = element_text(size=12), axis.title.y = element_text(size=12),title = element_text(size=10)) # center title
```

# Then let's look at relative proportion CPUE
# notice how the "disproportionate" differences aren't obvious in this plot because
# it's not standardized by annual averages
```{r, bar chart as % total annual catch}
# summarize total annual catches
abundance_annual <- abundance %>% 
  select(Slough, Yr, st0_cpue, sb0_cpue, tp0_cpue) %>% 
  group_by(Yr) %>% 
  summarize(st0_annual = sum(st0_cpue), sb0_annual = sum(sb0_cpue), tp0_annual = sum(tp0_cpue)) %>% 
  glimpse

# inner join
abundance_totals <- abundance %>%
  inner_join(abundance_annual, by="Yr")
View(abundance_totals)

# create new variables (relative catch)
abundance_totals$st0_perc <- (abundance_totals$st0_cpue/ abundance_totals$st0_annual)
abundance_totals$sb0_perc <- (abundance_totals$sb0_cpue/ abundance_totals$sb0_annual)
abundance_totals$tp0_perc <- (abundance_totals$tp0_cpue/ abundance_totals$tp0_annual)

# Convert to factors first
abundance_totals$Slough <- as.factor(abundance_totals$Slough)
abundance_totals$Yr <- as.factor(abundance_totals$Yr)
abundance_totals$YrSlough <- as.factor(abundance_totals$YrSlough)

# tidyr gather
abundance_totals_gathered <- abundance_totals %>% 
  select(Slough, Yr, st0_perc, sb0_perc, tp0_perc) %>% 
  gather(Species, Perc_Total_CPUE, st0_perc:tp0_perc)
View(abundance_totals_gathered)

# relative CPUE
bar_rel <- ggplot(abundance_totals_gathered, aes(x=Yr, y=Perc_Total_CPUE)) +
    geom_bar(stat="identity", position="identity") +
    scale_colour_excel() +
    theme_excel()
bar_rel + facet_grid(Species ~ Slough) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


## Plotting Averages
# Now let's look at mean cpue among Slough & Yr  for each speicies using dot plots
```{r, convert dataframe to from wide to long format}

# Following the R Cookbook:

## *http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/**

# Tidy data


# Convert to factors first
abundance$Slough <- as.factor(abundance$Slough)
abundance$Yr <- as.factor(abundance$Yr)
abundance$YrSlough <- as.factor(abundance$YrSlough)

# tidyr gather
abundance_gathered <- abundance %>% 
  gather(Species, Mean_CPUE, st0_cpue:tp0_cpue) 
View(abundance_gathered)
```


```{r, bar charts for mean cpue}
bar <- ggplot(abundance_gathered, aes(x = Yr, y = Mean_CPUE)) +
  geom_bar(stat="identity") +
  facet_grid(Species~Slough) +
  scale_colour_economist() +
  theme_economist_white()
bar + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Plotting mean catch (no year) according to (1) slough and (2) habitat categories
```{r}
## Catch
# Group by and Summarize
mean_abundance_slough <- abundance %>%
  group_by(Slough) %>% 
  summarize(Splittail = mean(st0_cpue), StripedBass = mean(sb0_cpue), TulePerch = mean(tp0_cpue))
View(mean_abundance_slough)

# tidyr gather
slough_gathered <- mean_abundance_slough %>% 
  gather(Species, Mean_CPUE, Splittail:TulePerch) 
View(slough_gathered)

# stacked bar 1: abundance
stacked_bar <- ggplot(slough_gathered, aes(x=reorder(Slough, Mean_CPUE), y=Mean_CPUE, fill=Species)) +
  geom_bar(stat="identity", size=0.25) +
  scale_fill_economist() +
  theme_economist_white() +
  coord_flip() +
  guides(fill=guide_legend(reverse=TRUE)) +
  labs(y="Average Catch Per Minute", x="", title="Young-of-Year by Slough")
stacked_bar + theme(plot.title = element_text(hjust = 0.5), legend.title = element_text(face="italic", size=12), axis.title.x = element_text(size=12), title = element_text(size=10)) # center title

## Habitat

habitat <- read_csv("~/GitHub/suisunmarsh/data/Suisun_Marsh_Habitat.csv")
View(habitat)

# Convert to factors first
habitat$Slough <- as.factor(habitat$Slough)
habitat$Habitat <- as.factor(habitat$Habitat)

#habitats <- habitat %>%
  #select(Slough, tidal, managed, upland, land) %>% 
  #group_by(Slough) %>% 
  #summarize(Tidal = tidal/land, Managed = managed/land, Upland = upland/land)

habitat_gathered <- habitat %>% 
  select(Habitat, Slough, tidal:channel) %>% 
  gather(Habitats, Proportion, tidal:channel)
View(habitat_gathered)

habitat_gathered$levels <- factor(habitat_gathered$Slough)

habitat_gathered$levels <- factor(habitat_gathered$levels, levels=c("Montezuma", "Boynton", "Cutoff", "Nurse", "Peytonia", "SuisunLower", "SuisunUpper", "Goodyear", "Spring Branch", "Denverton"))


stacked_bar2 <- ggplot(habitat_gathered, aes(x=levels, y=Proportion, fill=Habitats, order=desc(levels))) +
  geom_bar(stat="identity") +
  scale_fill_pander() +
  theme_economist_white() +
  coord_flip() +
  guides(fill=guide_legend(reverse=TRUE)) +
  labs(y="Relative Proportion", x="Slough", title="Land Cover 200m Buffer")
stacked_bar2 + facet_grid(.~Habitat)


```
  
```{r}

```



