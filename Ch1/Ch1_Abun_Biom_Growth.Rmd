---
title: "Ch1_Abun_Biom_Growth"
author: "Denise Colombano"
date: "March 10, 2017"
output: html_document
---
## Purpose of this exercise
Here I will compare abundance, biomass and growth of YOY fish to answer these 3 questions:

(1) Where are hotspots of abundance and biomass?
      - Identify and classify nurseries using plots of mean annual abundance and biomass per slough and/or per year
(2) When is peak abundance occurring? When is peak growth occurring?
      - Calculate change in mean biomass (=growth) on monthly and annual basis

```{r, load libraries and data}
# load libraries
library(tidyverse)
library(ggplot2)
library(magrittr)
library(ggthemes)

chapter1 <- read_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_Abundance.txt")
chapter1_biom2 <- read_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_BiomassEstimates_Age0.csv")

# check DFs for NAs or other import errors
summary(chapter1)
summary(chapter1_biom2)
```

### QUESTION 1
## HOTSPOT: ABUNDANCE
# Borrow code from previous analysis in file "Ch1_Abundance" to look at pos/neg differences in abundance
```{r}
## tidy dataset
abundance <- chapter1_biom2 %>% 
  select(Slough, YearMo, YrSlough, Mo, Yr, `ST_Age-0`, `SB_Age-0`, `TP_Age-0`, TowMin) %>% 
  filter(Mo > 4) %>% 
  group_by(Slough, Yr) %>% 
  summarize(st0_cpue = sum(`ST_Age-0`/ TowMin), sb0_cpue = sum(`SB_Age-0`/ TowMin), tp0_cpue = sum(`TP_Age-0`/ TowMin))
summary(abundance)

# Group by and Summarize
mean_abundance <- abundance %>%
  group_by(Yr) %>% 
  summarize(st0_mean = mean(st0_cpue), sb0_mean = mean(sb0_cpue), tp0_mean = mean(tp0_cpue))
View(mean_abundance)
summary(mean_abundance)
```

```{r, join back with chapter1 dataframe}

# Following this lesson:

## **https://ismayc.github.io/moderndiver-book/5-manip.html#joining-data-frames**

# inner join
abundance_joined <- abundance %>%
  inner_join(mean_abundance, by="Yr")
summary(abundance_joined)
```

```{r, create new columns for pos/neg differences}
## Calculate differences between CPUE and marsh-wide average (pos/neg)
abundance_differences <- abundance_joined %>% 
  mutate(Splittail = st0_cpue - st0_mean, Striped_Bass = sb0_cpue - sb0_mean, Tule_Perch = tp0_cpue - tp0_mean) %>%
  select(Slough, Yr, Splittail, Striped_Bass, Tule_Perch) %>% 
  glimpse

a <- abundance_differences # shorthand
View(a)
summary(a)
```

```{r, convert dataframe to from wide to long format}

# Following the R Cookbook:

## *http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/**

# Convert to factors first
a$Slough <- as.factor(a$Slough)
a$Yr <- as.factor(a$Yr)

# tidyr gather
a_gathered <- a %>% 
  gather(Species, Relative_CPUE, Splittail:Tule_Perch)
View(a_gathered)
```

Plot relative differences:
First let's look at disproportionately greater than average cPUE among Slough & Yr for each species,
Using the a_gathered dataframe, representing differences from the mean (0) for that year.

```{r, mean difference bar charts}
# with legend
a_gathered$Above_Annual_Mean <- a_gathered$Relative_CPUE >= 0
bar <- ggplot(a_gathered, aes(x=Yr, y=Relative_CPUE, fill=Above_Annual_Mean, guide=FALSE)) +
  geom_bar(stat="identity", position="identity") +
  theme_economist_white() +
  scale_fill_economist()+
  guides(fill=FALSE) +
  scale_x_discrete(name= "Year", breaks=c(1995, 2000, 2005, 2010, 2015))+
  labs(y="Catch Per Minute (Annual Mean=0)", x="", title="Relative Annual Catch of Young-of-Year")
bar + facet_grid(Species ~ Slough, scales="free") +
  theme(axis.text.x = element_text(angle = -90, hjust = 0.5), axis.ticks = element_line(size = 0.5), axis.ticks.length = unit(0.25, "cm")) +
  theme(plot.title = element_text(hjust = 0.5), axis.title.x = element_text(size=14), axis.title.y = element_text(size=12), title = element_text(size=10), axis.line.y = element_line(size=0.5), strip.text = element_text(size=10))
```

## HOTSPOT: BIOMASS

```{r}
## tidy dataset
biomass <- chapter1_biom2 %>% 
  select(Slough, YearMo, YrSlough, Mo, Yr, st0_b_tot, sb0_b_tot, tp0_b_tot, TowMin) %>% 
  filter(Mo > 4) %>% 
  group_by(Slough, Yr) %>% 
  summarize(st0_gpue = sum(st0_b_tot/ TowMin), sb0_gpue = sum(sb0_b_tot/ TowMin), tp0_gpue = sum(tp0_b_tot/ TowMin))
summary(biomass)

# Group by and Summarize
mean_biomass <- biomass %>%
  group_by(Yr) %>% 
  summarize(st0_mean = mean(st0_gpue), sb0_mean = mean(sb0_gpue), tp0_mean = mean(tp0_gpue))
View(mean_biomass)
summary(mean_biomass)
```

```{r, join back with chapter1 dataframe}

# Following this lesson:

## **https://ismayc.github.io/moderndiver-book/5-manip.html#joining-data-frames**

# inner join
biomass_joined <- biomass %>%
  inner_join(mean_biomass, by="Yr")
summary(biomass_joined)
```

```{r, create new columns for pos/neg differences}
## Calculate differences between CPUE and marsh-wide average (pos/neg)
biomass_differences <- biomass_joined %>% 
  mutate(Splittail = st0_gpue - st0_mean, Striped_Bass = sb0_gpue - sb0_mean, Tule_Perch = tp0_gpue - tp0_mean) %>%
  select(Slough, Yr, Splittail, Striped_Bass, Tule_Perch) %>% 
  glimpse

b <- biomass_differences # shorthand
View(b)
summary(b)
```

```{r, convert dataframe to from wide to long format}

# Following the R Cookbook:

## *http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/**

# Convert to factors first
b$Slough <- as.factor(a$Slough)
b$Yr <- as.factor(a$Yr)

# tidyr gather
b_gathered <- a %>% 
  gather(Species, Relative_CPUE, Splittail:Tule_Perch)
View(b_gathered)
```

Plot relative differences:
First let's look at disproportionately greater than average cPUE among Slough & Yr for each species,
Using the a_gathered dataframe, representing differences from the mean (0) for that year.

```{r, mean difference bar charts}
# with legend
b_gathered$Above_Annual_Mean <- b_gathered$Relative_CPUE >= 0
bar <- ggplot(b_gathered, aes(x=Yr, y=Relative_CPUE, fill=Above_Annual_Mean, guide=FALSE)) +
  geom_bar(stat="identity", position="identity") +
  theme_economist_white() +
  scale_fill_economist()+
  guides(fill=FALSE) +
  scale_x_discrete(name= "Year", breaks=c(1995, 2000, 2005, 2010, 2015))+
  labs(y="Catch Per Minute (Annual Mean=0)", x="", title="Relative Annual Biomass of Young-of-Year")
bar + facet_grid(Species ~ Slough, scales="free") +
  theme(axis.text.x = element_text(angle = -90, hjust = 0.5), axis.ticks = element_line(size = 0.5), axis.ticks.length = unit(0.25, "cm")) +
  theme(plot.title = element_text(hjust = 0.5), axis.title.x = element_text(size=14), axis.title.y = element_text(size=12), title = element_text(size=10), axis.line.y = element_line(size=0.5), strip.text = element_text(size=10))
```

## BAR CHART SUMMARIES: HOTSPOTS for ABUNDANCE & BIOMASS at EACH SLOUGH (AVERAGED OVER TOTAL ANNUAL)
# Borrow code from Ch1_Abundance file again

```{r, calculate average annual abundance over 21 years}
## Calculate average ANNUAL cPUE (21 data points)

abunbiom <- abundance %>%
  inner_join(biomass, by="YrMoSite")

# calculate mean CPUE and SE per slough
# use plotrix pacakge to calculate SE
annual_mean_cpue <- abundance %>% 
  group_by(Slough) %>% 
  summarize(Splittail = mean(st0_cpue), StripedBass = mean(sb0_cpue), TulePerch = mean(tp0_cpue), Splittail_SE =std.error(st0_cpue,na.rm), StripedBass_SE =std.error(sb0_cpue,na.rm), TulePerch_SE =std.error(tp0_cpue,na.rm)) %>% 
  write.csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_Annual_Abun_Mean&SE_Age0.csv", row.names=FALSE)
```


###QUESTION 2. 
## 