---
title: "Ch1_Biomass_Estimates"
author: "Denise Colombano"
date: "March 4, 2017"
output: html_document
---

```{r, import dataframe}
library(tidyverse)
library(ggplot2)
library(magrittr)
library(ggthemes)
library(gcookbook)
library(grid)
library(plotrix)
library(readr)

# read in csv file with abundance data for each age class (incl. NAs)
chapter1_ab <- read_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_AgeClass_Abun_Estimates.txt")

chapter1_ab <- chapter1_ab %>% 
  filter(Yr>=1995)

View(chapter1_ab)
glimpse(chapter1_ab)
summary(chapter1_ab)

# read in csv file with length data (incl. NAs) in order to calculate biomass
# which will then be joined to the abundance dataframe
# this file originates from the MS Access dB query "Qry_AgeClass_SL_ForBiomassCalc1" with years filtered >=1995
chapter1_lw <- read_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_StandardLengths_1995-2016.txt") # 66973 rows

chapter1_lw <- chapter1_lw %>% 
  filter(SampleYear>=1995) #71135 rows

View(chapter1_lw)
glimpse(chapter1_lw)
summary(chapter1_lw)

# read in CSV file with 5223 rows
chapter1 <- read_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_Abundance.txt")
```

```{r, Table of Contents}

## Step 1. Calculate biomass for measured fish using Standard Lengths and LW-Regression formulas
# Plots generated with measured fish
sb_regression
st_regression
tp_regression
sf_regression

# Dataframe with calculated biomass for measured fish (SL x equation x count)
View(biomass_msrd) # 5223 rows

## Step 2. Calculate biomass for unmeasured (plus-counted) fish
# Estimate standard lengths for each species, age class, month and year (marsh-wide, not site-specific)
View(biomass_unmsrd) # 966 rows 

# Write CSV file: "Data_Ch1_EstimatesForUnmeasuredFish" containing all data for creating estimated biomass

# Combine unmeasured and measured total biomass
View(biomass_totals)

## STEP 3. Join biomass estimates to regular DF (Chapter1 - Data_Ch1_Abundance)
# And create new dataframe "Data_Ch1_Biomass_Estimates"
```


### STEP 1. Calculating biomass for measured fish

```{r, biomass calculations, test}

## Calculate biomass using two different methods and compare

# strategy 1: STEP BY STEP EQUATIONS
chapter1_ex <- chapter1_lw %>% 
  select(YrMoSite, YearMo, StationCode, SampleYear, YrMoSpp, OrganismCode, Count, StandardLength, AgeClass) %>% 
  filter(AgeClass=="Age-0" & OrganismCode=="SB") %>% 
  mutate(sb0_g = StandardLength^3.25) %>% 
  mutate(sb0_g = sb0_g*0.0034) %>% 
  mutate(sb0_g = sb0_g *Count) %>% 
  mutate(sb0_g = sb0_g /1000) 

# strategy 2: SINGLE EQUATION
chapter1_ex2 <- chapter1_lw %>% 
  select(id, YrMoSite, YearMo, StationCode, SampleYear, YrMoSpp, OrganismCode, Count, StandardLength, AgeClass) %>% 
  filter(AgeClass=="Age-0" & OrganismCode=="SB") %>% 
  mutate(sb0_g = (((StandardLength^3.25)*0.0034)*Count)/1000)

# strategy 3: SINGLE EQUATION
chapter1_ex3 <- chapter1_lw %>% 
  select(id, YrMoSite, YearMo, StationCode, SampleYear, YrMoSpp, OrganismCode, Count, StandardLength, AgeClass) %>% 
  filter(AgeClass=="Age-0" & OrganismCode=="SB") %>% 
  group_by(id) %>% 
  mutate(sb0_g = ((StandardLength^3.25)*0.0034)*Count/1000)

# Compare the dataframes = **THE SAME**
View(chapter1_ex)
View(chapter1_ex2)
View(chapter1_ex3)

# Compare the plots = **THE SAME**
ex <- ggplot(chapter1_ex, aes(x=StandardLength, y=sb0_g)) + 
  geom_point() 
ex

ex3 <- ggplot(chapter1_ex3, aes(x=StandardLength, y=sb0_g)) + 
  geom_point() 
ex3
```

```{r, biomass calculations, for real}

## CALCULATIONS: Separate dataframes
sb_biomass <- chapter1_lw %>% 
  select(YrMoSite, YearMo, StationCode, SampleYear, YrMoSpp, OrganismCode, Count, StandardLength, AgeClass) %>% 
  filter(OrganismCode=="SB")%>%
  filter(!is.na(AgeClass)) %>% 
  mutate(sb_g = ((StandardLength^3.25)*0.0034)*Count/1000)
glimpse(sb_biomass)
View(sb_biomass)

# Splittail
st_biomass <- chapter1_lw %>% 
  select(YrMoSite, YearMo, StationCode, SampleYear, YrMoSpp, OrganismCode, Count, StandardLength, AgeClass) %>% 
  filter(OrganismCode=="ST") %>% 
  filter(!is.na(AgeClass)) %>% 
  mutate(st_g = ((StandardLength^3.30)*0.0026)*Count/1000)
glimpse(st_biomass)

# Tule Perch
tp_biomass <- chapter1_lw %>% 
  select(YrMoSite, YearMo, StationCode, SampleYear, YrMoSpp, OrganismCode, Count, StandardLength, AgeClass) %>% 
  filter(OrganismCode=="TP") %>% 
  filter(!is.na(AgeClass)) %>% 
  mutate(tp_g = ((StandardLength^2.96)*0.0289)*Count/1000)
glimpse(tp_biomass)

# Starry Flounder
sf_biomass <- chapter1_lw %>% 
  select(YrMoSite, YearMo, StationCode, SampleYear, YrMoSpp, OrganismCode, Count, StandardLength, AgeClass) %>% 
  filter(OrganismCode=="SF") %>% 
  filter(!is.na(AgeClass)) %>% 
  mutate(sf_g = ((StandardLength^3.13)*0.0082)*Count/1000)
glimpse(sf_biomass)

## double check plots of L-W Relationships
sb_regression <- ggplot(sb_biomass, aes(x=StandardLength, y=sb_g)) + 
  geom_point()
st_regression <- ggplot(st_biomass, aes(x=StandardLength, y=st_g)) + 
  geom_point()
tp_regression <- ggplot(tp_biomass, aes(x=StandardLength, y=tp_g)) + 
  geom_point()
sf_regression <- ggplot(sf_biomass, aes(x=StandardLength, y=sf_g)) + 
  geom_point()

sb_regression
st_regression
tp_regression
sf_regression

## double check plots of abundance + biomass for potential outliers
sb_outlier <- ggplot(sb_biomass, aes(x=Count, y=sb_g)) +
  geom_point() + facet_grid(AgeClass~., scales="free")
sb_outlier

st_outlier <- ggplot(st_biomass, aes(x=Count, y=st_g)) +
  geom_point() + facet_grid(AgeClass~., scales="free")
st_outlier

tp_outlier <- ggplot(tp_biomass, aes(x=Count, y=tp_g)) +
  geom_point() + facet_grid(AgeClass~., scales="free")
tp_outlier

sf_outlier <- ggplot(sf_biomass, aes(x=Count, y=sf_g)) +
  geom_point() + facet_grid(AgeClass~., scales="free")
sf_outlier
```


```{r, Remove outliers that are >2 SD from the mean}
chapter1_sb_tidy <- sb_biomass %>%
  group_by(YrMoSite) %>%
  filter(AgeClass=="Age-0",(abs(sb_g - median(sb_g)) > 2*sd(sb_g))) %>%
  summarise_each(funs(mean), sb_g)

```


```{r}

## CONVERT TO LONGFORM DF
# The joined biomass DF only has estimated biomass for measured fish; need to add plus-counted fish after.

# striped bass
sb_biomass_sum <- sb_biomass %>% 
  select(YrMoSite:SampleYear, AgeClass, sb_g) %>% 
  group_by(YrMoSite, AgeClass) %>% 
  summarize(sb_b = sum(sb_g)) %>% 
  filter(!is.na(AgeClass)) %>% 
  spread(AgeClass, sb_b, fill=0, convert=FALSE) %>% 
  rename(sb0_b = `Age-0`, sb1_b = `Age-1`, sb2_b = `Age-2+`)
View(sb_biomass_sum)

# splittail
st_biomass_sum <- st_biomass %>% 
  select(YrMoSite:SampleYear, AgeClass, st_g) %>% 
  group_by(YrMoSite, AgeClass) %>% 
  summarize(st_b = sum(st_g)) %>% 
  filter(!is.na(AgeClass)) %>% 
  spread(AgeClass, st_b, fill=0, convert=FALSE) %>% 
  rename(st0_b = `Age-0`, st1_b = `Age-1`, st2_b = `Age-2+`)
View(st_biomass_sum)

# tule perch
tp_biomass_sum <- tp_biomass %>% 
  select(YrMoSite:SampleYear, AgeClass, tp_g) %>% 
  group_by(YrMoSite, AgeClass) %>% 
  summarize(tp_b = sum(tp_g)) %>% 
  filter(!is.na(AgeClass)) %>% 
  spread(AgeClass, tp_b, fill=0, convert=FALSE) %>% 
  rename(tp0_b = `Age-0`, tp1_b = `Age-1+`)
View(tp_biomass_sum)

# starry flounder
sf_biomass_sum <- sf_biomass %>% 
  select(YrMoSite:SampleYear, AgeClass, sf_g) %>% 
  group_by(YrMoSite, AgeClass) %>% 
  summarize(sf_b = sum(sf_g)) %>% 
  filter(!is.na(AgeClass)) %>% 
  spread(AgeClass, sf_b, fill=0, convert=FALSE) %>% 
  rename(sf0_b = `Age-0`, sf1_b = `Age-1`, sf2_b = `Age-2+`)
View(sf_biomass_sum)
## RETURN TO WIDE FORMAT, THEN JOIN WITH CHAPTER 1 DF

biomass_msrd <- chapter1 %>%
  full_join(st_biomass_sum, by=c("YrMoSite")) %>% 
  full_join(sb_biomass_sum, by=c("YrMoSite")) %>%
  full_join(tp_biomass_sum, by=c("YrMoSite")) %>%
  full_join(sf_biomass_sum, by=c("YrMoSite")) %>% 
  select(YrMoSite, st0_b:sf2_b)

# Transform NAs into zeros
biomass_msrd[is.na(biomass_msrd)] <- 0

View(biomass_msrd)
```
# checked biomass calculations- look good so far - for measured fish.


### STEP 2. Calculating estimated biomass for unmeasured fish

```{r, add estimated lengths to unmeasured fish, in order to calculate biomass later}
## CALCULATE Average SL at each YrMoSite
# When a fish was measured and assigned an age class, what was the average length of them for each YrMoSite?
# all lengths- 1910 rows
mean_sl_all<- chapter1_lw %>% 
  select(YrMoSite, YearMo, YrMoSpp, OrganismCode, AgeClass, StandardLength) %>% 
  filter(!is.na(AgeClass)) %>% 
  group_by(YrMoSpp, AgeClass) %>% 
  summarize(mean_sl=mean(StandardLength))
```

```{r, tidy data in chapter1_ab DF}
# convert dataframe to long form, with species and age classes
# 83,568 rows because 5223 x 4 species x 4 ages
# then filtered down to 966 where count >0
chapter1_ab_gathered <- chapter1_ab %>% 
  select(YrMoSite, YearMo, OrganismCode, YrMoSpp, `Est_Age-0`, `Est_Age-1`, `Est_Age-1+`, `Est_Age-2+`) %>% 
  rename("Age-0" = `Est_Age-0` , "Age-1" = `Est_Age-1` , "Age-1+" = `Est_Age-1+` , "Age-2+" = `Est_Age-2+`) %>% 
  gather(AgeClass, Count, `Age-0`:`Age-2+`) %>% 
  filter(Count>0)

chapter1_ab_gathered_joined <- chapter1_ab_gathered %>% 
  inner_join(mean_sl_all, by=c("YrMoSpp", "AgeClass"))
```
# now we have the plus-counted fish and their estimated lengths for each estimated age class (my brain hurts)



```{r}
# Create a DF that has estimated biomass for each estimated length for unmeasured fish
# Step 1. Create sub-DF with estimated biomass for each species

# Unmeasured age-0 fish
unmsr_age_sb <- chapter1_ab_gathered_joined %>% 
  filter(OrganismCode=="SB") %>% 
  mutate(sb_b_est = ((mean_sl^3.25)*0.0034)*Count/1000) %>% 
  select(YrMoSite, OrganismCode, AgeClass, Count, sb_b_est) %>% 
  group_by(YrMoSite) %>% 
  mutate(sb_b_est_tot = (sb_b_est * Count)) %>% 
  select(YrMoSite, AgeClass, sb_b_est_tot) %>% 
  spread(AgeClass, sb_b_est_tot, fill=0, convert=FALSE) %>% 
  rename(sb0_bu = `Age-0`, sb1_bu = `Age-1`, sb2_bu = `Age-2+`)
View(unmsr_age_sb)

unmsr_age_st <- chapter1_ab_gathered_joined %>% 
  filter(OrganismCode=="ST") %>% 
  mutate(st_b_est = ((mean_sl^3.30)*0.0026)*Count/1000) %>% 
  select(YrMoSite, OrganismCode, AgeClass, Count, st_b_est) %>% 
  group_by(YrMoSite) %>% 
  mutate(st_b_est_tot = (st_b_est * Count)) %>% 
  select(YrMoSite, AgeClass, st_b_est_tot) %>% 
  spread(AgeClass, st_b_est_tot, fill=0, convert=FALSE) %>% 
  rename(st0_bu = `Age-0`, st1_bu = `Age-1`, st2_bu = `Age-2+`)
View(unmsr_age_st)

unmsr_age_tp <- chapter1_ab_gathered_joined %>% 
  filter(OrganismCode=="TP") %>% 
  mutate(tp_b_est = ((mean_sl^2.96)*0.0289)*Count/1000) %>% 
  select(YrMoSite, OrganismCode, AgeClass, Count, tp_b_est) %>% 
  group_by(YrMoSite) %>% 
  mutate(tp_b_est_tot = (tp_b_est * Count)) %>% 
  select(YrMoSite, AgeClass, tp_b_est_tot) %>% 
  spread(AgeClass, tp_b_est_tot, fill=0, convert=FALSE) %>% 
  rename(tp0_bu = `Age-0`, tp1_bu = `Age-1+`)
View(unmsr_age_tp)

# there are no plus-counted SF fish
unmsr_age_sf <- chapter1_ab_gathered_joined %>% 
  filter(OrganismCode=="SF") %>% 
  mutate(sf_b_est = ((mean_sl^3.13)*0.0082)*Count/1000) %>% 
  select(YrMoSite, OrganismCode, AgeClass, Count, sf_b_est) %>% 
  group_by(YrMoSite) %>% 
  mutate(sf_b_est_tot = (sf_b_est * Count)) %>% 
  select(YrMoSite, AgeClass, sf_b_est_tot) %>% 
  spread(AgeClass, sf_b_est_tot, fill=0, convert=FALSE) %>% 
  rename(sf_b0 = `Age-0`, sf1_b = `Age-1+`)
View(unmsr_age_sf)

## Join back with 966 rows that have unmeasured fish estimated lengths
# replace NAs with zeros
# rename file so I can remember what it is
biomass_msrd_unmsrd <- biomass_msrd %>% 
  full_join(unmsr_age_sb, by=c("YrMoSite")) %>% 
  full_join(unmsr_age_st, by=c("YrMoSite")) %>% 
  full_join(unmsr_age_tp, by=c("YrMoSite")) 

biomass_msrd_unmsrd[is.na(biomass_msrd_unmsrd)] <- 0
```
# now I have a DF with estimated biomass of measured AND unmeasured fish for each sampling event

```{r. the holy grail= TOTAL BIOMASS OF MEASURED AND UNMEASURED = TOGETHER!}
# add the measured and unmeasured columns together for a TOTAL biomass estimate for each 5,223 rows
biomass_totals <- biomass_msrd_unmsrd %>% 
  group_by(YrMoSite) %>% 
  mutate(sb0_b_tot = sb0_b + sb0_bu, st0_b_tot = st0_b + st0_bu, tp0_b_tot = tp0_b + tp0_bu, sb1_b_tot = sb1_b + sb1_bu, st1_b_tot = st1_b + st1_bu, tp1_b_tot = tp1_b + tp1_bu, sb2_b_tot = sb2_b + sb2_bu, st2_b_tot = st2_b + st2_bu, sf0_b_tot= sf0_b, sf1_b_tot = sf1_b, sf2_b_tot = sf2_b) %>% 
  select(YrMoSite, sb0_b_tot:sf2_b_tot)

biomass_totals[is.na(biomass_totals)] <- 0
```


### STEP 3. ADD TO REGULAR DF
```{r}
#chapter1 <- read_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_Abundance.txt")
View(chapter1)
glimpse(chapter1)
chapter1$id <- 1:5223
str(chapter1)
summary(chapter1)

chapter1_biom <- chapter1 %>% 
  inner_join(biomass_totals, yr="YrMoSite") 

summary(chapter1_biom)

biomass_age0_gpue <- chapter1_biom %>% 
  select(YrMoSite, st0_b_tot, sb0_b_tot, tp0_b_tot, sf0_b_tot, TowMin) %>% 
  group_by(YrMoSite) %>% 
  summarize(st0_gpue = sum(st0_b_tot/ TowMin), sb0_gpue = sum(sb0_b_tot/ TowMin), tp0_gpue = sum(tp0_b_tot/ TowMin), sf0_gpue = sum(sf0_b_tot/ TowMin))
summary(biomass_age0_gpue)

# join mean gpue with main DF
chapter1_biom <- chapter1_biom %>% 
  inner_join(biomass_age0_gpue, by="YrMoSite")

View(chapter1_biom)

# write CSV file
chapter1_biom %>% 
  write_csv("~/GitHub/suisunmarsh/Ch1/Data_Ch1_BiomassEstimates.csv")
```

# need to double-check numbers with scatter plots

```{r}
# Age-0
st0_check <- ggplot(chapter1_biom, aes(x=`ST_Age-0`, y=st0_b_tot)) + 
  geom_point()
st0_check

sb0_check <- ggplot(chapter1_biom, aes(x=`SB_Age-0`, y=sb0_b_tot)) + 
  geom_point()
sb0_check

tp0_check <- ggplot(chapter1_biom, aes(x=`TP_Age-0`, y=tp0_b_tot)) + 
  geom_point()
tp0_check

# Age-1
st1_check <- ggplot(chapter1_biom, aes(x=`ST_Age-1`, y=st1_b_tot)) + 
  geom_point()
st1_check

sb1_check <- ggplot(chapter1_biom, aes(x=`SB_Age-1`, y=sb1_b_tot)) + 
  geom_point()
sb1_check

tp1_check <- ggplot(chapter1_biom, aes(x=`TP_Age-1+`, y=tp1_b_tot)) + 
  geom_point()
tp1_check
```




## PLOTS
# stacked area plot of annual biomass by year- code stolen from Ch1_Abundance file
```{r, stacked area graph by Yr}
biomass_yr <- chapter1_biom %>% 
  select(Yr, st0_b_tot, sb0_b_tot, tp0_b_tot, st1_b_tot, sb1_b_tot, tp1_b_tot, st2_b_tot, sb2_b_tot, TowMin) %>% 
  group_by(Yr) %>% 
  summarize(ST_YOY=sum(st0_b_tot)/ sum(TowMin), SB_YOY=sum(sb0_b_tot)/ sum(TowMin), TP_YOY=sum(tp0_b_tot)/ sum(TowMin), ST_Older = sum(st1_b_tot)/ sum(TowMin), SB_Older=sum(sb1_b_tot)/ sum(TowMin), TP_Older=sum(tp1_b_tot)/ sum(TowMin))
glimpse(biomass_yr)
summary(biomass_yr)

# tidyr
biomass_yr$Yr <- as.factor(biomass_yr$Yr)

# tidyr gather
biomass_yr_gathered <- biomass_yr %>% 
  select(Yr, ST_YOY:TP_Older) %>% 
  gather(`Species+Stage`, GPUE, ST_YOY:TP_Older)
View(biomass_yr_gathered)
glimpse(biomass_yr_gathered)

# stacked area plot
stacked_area <- ggplot(biomass_yr_gathered, aes(x=Yr, y=GPUE, fill=`Species+Stage`, group=`Species+Stage`)) +
  geom_area(stat="identity") +
  scale_fill_economist() +
  theme_economist_white() +
  guides(fill=guide_legend(reverse=TRUE)) +
  scale_x_discrete(breaks=c(1995, 2000, 2005, 2010, 2015)) +
  labs(y="Grams Per Minute", x="", title="Total Biomass of Young-of-Year")
stacked_area + theme(plot.title = element_text(hjust = 0.5), legend.title = element_text(face="italic", size=16), axis.title.y = element_text(size=16),title = element_text(size=16)) # center title
```
```

